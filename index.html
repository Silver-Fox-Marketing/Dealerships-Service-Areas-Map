<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealership Prospecting Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* Search Bar */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            max-width: 90%;
        }

        .search-icon {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .search-input {
            border: none;
            outline: none;
            padding: 12px 15px 12px 0;
            font-size: 16px;
            width: 400px;
            display: none;
        }

        .search-input.active {
            display: block;
        }

        .search-results {
            position: absolute;
            top: 55px;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Control Panel Trigger */
        .control-trigger {
            position: absolute;
            top: 90px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .control-trigger:hover {
            background: white;
            transform: scale(1.1);
        }

        /* Control Panel Modal */
        .control-panel {
            position: absolute;
            top: 150px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 240px;
            display: none;
        }

        .control-panel.active {
            display: block;
        }

        .control-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 8px;
        }

        .control-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .control-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .control-item label {
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .icon-button {
            flex: 1;
            padding: 10px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            background: #3367D6;
            transform: scale(1.05);
        }

        .icon-button.danger {
            background: #EA4335;
        }

        .icon-button.danger:hover {
            background: #C5221F;
        }

        .dealership-count {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        /* Legend Modal */
        .legend-trigger {
            position: absolute;
            bottom: 150px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .legend-trigger:hover {
            background: white;
            transform: scale(1.1);
        }

        .legend-modal {
            position: absolute;
            bottom: 210px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 320px;
        }

        .legend-modal.active {
            display: block;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .legend-label {
            font-size: 14px;
            color: #555;
        }

        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
        }

        .loading.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-input {
                width: 250px;
            }

            .control-trigger {
                width: 45px;
                height: 45px;
                font-size: 20px;
                top: 80px;
                right: 10px;
            }

            .control-panel {
                right: 10px;
                top: 135px;
                font-size: 13px;
                padding: 15px;
                min-width: 200px;
            }

            .legend-trigger {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .icon-button {
                font-size: 18px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="loading" id="loading">Searching for dealerships...</div>

    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-icon" onclick="toggleSearch()">üîç</div>
        <input type="text" class="search-input" id="searchInput" placeholder="Search location..." oninput="performSearch()">
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Control Panel Trigger -->
    <div class="control-trigger" onclick="toggleControls()">‚öôÔ∏è</div>

    <!-- Control Panel Modal -->
    <div class="control-panel" id="controlPanel">
        <div class="control-title">Map Controls</div>
        <div class="control-item">
            <input type="checkbox" id="showClients" checked onchange="toggleMarkers('clients')">
            <label for="showClients">Show Our Clients</label>
        </div>
        <div class="control-item">
            <input type="checkbox" id="showProspects" checked onchange="toggleMarkers('prospects')">
            <label for="showProspects">Show Our Prospects</label>
        </div>
        <div class="control-item">
            <input type="checkbox" id="showOtherDealerships" checked onchange="toggleMarkers('other')">
            <label for="showOtherDealerships">Show Other Dealerships</label>
        </div>
        <div class="control-item">
            <input type="checkbox" id="showCircles" onchange="toggleCircles()">
            <label for="showCircles">Show Service Areas</label>
        </div>
        <div class="control-buttons">
            <button class="icon-button" onclick="searchDealershipsInView()" title="Find Dealerships in View">üîÑ</button>
            <button class="icon-button danger" onclick="clearOtherDealerships()" title="Clear Other Dealerships">üóëÔ∏è</button>
        </div>
        <div class="dealership-count" id="dealershipCount">
            Clients: 0 | Prospects: 0 | Other: 0
        </div>
    </div>

    <!-- Legend Trigger -->
    <div class="legend-trigger" onclick="toggleLegend()">‚ÑπÔ∏è</div>

    <!-- Legend Modal -->
    <div class="legend-modal" id="legendModal">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4285F4;"></div>
            <div class="legend-label">Our Client Dealerships</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #EA4335;"></div>
            <div class="legend-label">Our Prospect Dealerships</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #FBBC04;"></div>
            <div class="legend-label">Other Dealerships (Potential Prospects)</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(66, 133, 244, 0.15); border: 2px solid #4285F4;"></div>
            <div class="legend-label">Service Area Radius (20 miles)</div>
        </div>
    </div>

    <script>
        let map;
        let markers = {
            clients: [],
            prospects: [],
            other: []
        };
        let circles = [];
        let infoWindow;
        let placesService;
        let searchActive = false;
        let processedPlaceIds = new Set();

        // Our client dealerships (exact list)
        const clientNames = [
            "Ackerman Toyota", "Audi Creve Coeur", "BMW of Columbia", "BMW of West St. Louis",
            "Bommarito Automotive Group", "Bommarito Ford", "Bommarito Honda", "Bommarito Infiniti",
            "Bommarito Nissan", "Bommarito Nissan West", "Bommarito Volkswagen",
            "Bommarito West County Pre-Owned", "Capital City CDJR", "CDJR of Columbia",
            "Columbia Honda", "Dave Sinclair Lincoln", "Dave Sinclair Lincoln St. Peters",
            "Glendale CDJR", "Honda of Frontenac", "HW KIA", "Joe Machens Capital City Ford",
            "Joe Machens CDJR", "Joe Machens Ford", "Joe Machens Hyundai", "Joe Machens Nissan",
            "Joe Machens Toyota", "KIA Of Columbia", "Mazda of Columbia", "Mini of St. Louis",
            "Pappas Toyota", "Porsche St. Louis", "Pundmann Ford", "Rusty Drewing Cadillac",
            "Rusty Drewing Chevrolet", "Serra Honda", "South County DCJR", "Spirit Lexus",
            "Suntrup Buick GMC", "Suntrup Ford Kirkwood", "Suntrup Ford Westport",
            "Thoroughbred Ford", "Volvo Cars West County"
        ];

        const prospectNames = [
            "Cable Dahmer Chevrolet", "Cable Dahmer Buick GMC", "Cable Dahmer Cadillac",
            "Cable Dahmer CDJR", "Reliable Chevrolet", "Fletcher Chrysler", "Fletcher Hyundai",
            "Fletcher Toyota", "Frank Fletcher Ford", "Jim Butler Auto Group", "Bob McCosh"
        ];

        const clients = [
            {"name": "Ackerman Toyota", "lat": 38.6196629, "lng": -90.2877421},
            {"name": "Audi Creve Coeur", "lat": 38.6703144, "lng": -90.4445789},
            {"name": "BMW of Columbia", "lat": 38.9660013, "lng": -92.3658507},
            {"name": "BMW of West St. Louis", "lat": 38.5935178, "lng": -90.5172807},
            {"name": "Bommarito Automotive Group", "lat": 38.5919798, "lng": -90.5791758},
            {"name": "Bommarito Ford", "lat": 38.7816575, "lng": -90.3715382},
            {"name": "Bommarito Honda", "lat": 38.7759257, "lng": -90.3611785},
            {"name": "Bommarito Infiniti", "lat": 38.5920883, "lng": -90.5786057},
            {"name": "Bommarito Nissan", "lat": 38.7815362, "lng": -90.3710642},
            {"name": "Bommarito Nissan West", "lat": 38.5937193, "lng": -90.5328992},
            {"name": "Bommarito Volkswagen", "lat": 38.7766669, "lng": -90.3613796},
            {"name": "Bommarito West County Pre-Owned", "lat": 38.5919798, "lng": -90.5791758},
            {"name": "Capital City CDJR", "lat": 38.5813522, "lng": -92.2420047},
            {"name": "CDJR of Columbia", "lat": 38.97152, "lng": -92.331159},
            {"name": "Columbia Honda", "lat": 38.9684693, "lng": -92.3109424},
            {"name": "Dave Sinclair Lincoln", "lat": 38.5929786, "lng": -90.5437428},
            {"name": "Dave Sinclair Lincoln St. Peters", "lat": 38.7994462, "lng": -90.5984636},
            {"name": "Glendale CDJR", "lat": 38.6142445, "lng": -90.3138193},
            {"name": "Honda of Frontenac", "lat": 38.5932125, "lng": -90.4951632},
            {"name": "HW KIA", "lat": 38.5932125, "lng": -90.4951632},
            {"name": "Joe Machens Capital City Ford", "lat": 38.577773, "lng": -92.200375},
            {"name": "Joe Machens CDJR", "lat": 38.971117, "lng": -92.3201024},
            {"name": "Joe Machens Ford - Columbia", "lat": 38.960848, "lng": -92.3671085},
            {"name": "Joe Machens Hyundai", "lat": 38.9711176, "lng": -92.3203335},
            {"name": "Joe Machens Nissan", "lat": 38.966624, "lng": -92.334848},
            {"name": "Joe Machens Toyota", "lat": 38.9711237, "lng": -92.3230257},
            {"name": "KIA Of Columbia", "lat": 38.96767, "lng": -92.3631493},
            {"name": "Mazda of Columbia", "lat": 38.9708255, "lng": -92.333717},
            {"name": "Mini of St. Louis", "lat": 38.6070157, "lng": -90.3316875},
            {"name": "Pappas Toyota", "lat": 38.8004582, "lng": -90.6018787},
            {"name": "Porsche St. Louis", "lat": 38.6096211, "lng": -90.3335962},
            {"name": "Pundmann Ford", "lat": 38.7845129, "lng": -90.5218376},
            {"name": "Rusty Drewing Cadillac", "lat": 38.5499397, "lng": -92.2016708},
            {"name": "Rusty Drewing Chevrolet Buick GMC", "lat": 38.5499397, "lng": -92.2016708},
            {"name": "Serra Honda", "lat": 38.5825956, "lng": -89.9383136},
            {"name": "South County DCJR", "lat": 38.5081902, "lng": -90.3295901},
            {"name": "Spirit Lexus", "lat": 38.6798212, "lng": -90.4032839},
            {"name": "Suntrup Buick GMC", "lat": 38.7979921, "lng": -90.5780065},
            {"name": "Suntrup Ford Kirkwood", "lat": 38.5998853, "lng": -90.3986889},
            {"name": "Suntrup Ford Westport", "lat": 38.6960762, "lng": -90.4045543},
            {"name": "Thoroughbred Ford", "lat": 39.2491586, "lng": -94.6553814},
            {"name": "Volvo Cars West County", "lat": 38.5928645, "lng": -90.5168575}
        ];

        const prospects = [
            {"name": "Cable Dahmer Chevrolet of Kansas City", "lat": 38.9409311, "lng": -94.5990562},
            {"name": "Cable Dahmer Buick GMC of Kansas City", "lat": 38.9399156, "lng": -94.6029304},
            {"name": "Cable Dahmer Cadillac of Kansas City", "lat": 38.9399411, "lng": -94.6042905},
            {"name": "Cable Dahmer CDJR Kansas City", "lat": 38.9399245, "lng": -94.6034544},
            {"name": "Reliable Chevrolet", "lat": 37.1479256, "lng": -93.2969749},
            {"name": "Fletcher Chrysler Jeep Dodge Ram", "lat": 37.0548055, "lng": -94.4928621},
            {"name": "Fletcher Hyundai", "lat": 37.0548055, "lng": -94.4928621},
            {"name": "Fletcher Toyota", "lat": 37.0660915, "lng": -94.4780776},
            {"name": "Frank Fletcher Ford", "lat": 37.0949768, "lng": -94.4751034},
            {"name": "Cable Dahmer Buick GMC of Independence", "lat": 39.0707781, "lng": -94.414906},
            {"name": "Cable Dahmer Chevrolet of Independence", "lat": 39.064449, "lng": -94.414515},
            {"name": "Jim Butler Auto Group", "lat": 38.5060135, "lng": -90.4507989},
            {"name": "Bob McCosh Chevrolet Buick GMC Cadillac", "lat": 38.96767, "lng": -92.3631493}
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 38.5, lng: -92.5 },
                zoom: 7,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            infoWindow = new google.maps.InfoWindow();
            placesService = new google.maps.places.PlacesService(map);

            // Create client markers
            clients.forEach(dealership => {
                createMarker(dealership, 'clients', '#4285F4');
                createServiceCircle(dealership.lat, dealership.lng);
            });

            // Create prospect markers
            prospects.forEach(dealership => {
                createMarker(dealership, 'prospects', '#EA4335');
            });

            // Don't auto-search on load - let user click button manually
            updateDealershipCount();
        }

        function createMarker(dealership, type, color) {
            const marker = new google.maps.Marker({
                position: { lat: dealership.lat, lng: dealership.lng },
                map: map,
                title: dealership.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: type === 'other' ? 6 : 8,
                    fillColor: color,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                dealershipType: type,
                dealershipData: dealership
            });

            marker.addListener('click', () => {
                showPlaceInfo(marker, dealership);
            });

            markers[type].push(marker);
            return marker;
        }

        function createServiceCircle(lat, lng) {
            const circle = new google.maps.Circle({
                center: { lat, lng },
                radius: 32186.9, // 20 miles
                fillColor: '#4285F4',
                fillOpacity: 0.15,
                strokeColor: '#4285F4',
                strokeOpacity: 0.4,
                strokeWeight: 1,
                map: null
            });
            circles.push(circle);
        }

        function searchDealershipsInView() {
            document.getElementById('loading').classList.add('active');

            // Don't clear existing markers - accumulate instead!
            // This way zooming in preserves previously found dealerships

            const bounds = map.getBounds();
            if (!bounds) {
                document.getElementById('loading').classList.remove('active');
                console.log('No bounds available');
                return;
            }

            // Create a grid of search points to cover the visible area
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();

            // Calculate how many grid points we need based on zoom level
            const zoom = map.getZoom();
            let gridSize;
            let searchRadius;

            if (zoom <= 7) {
                // Zoomed way out (state level) - 3x3 grid
                gridSize = 3;
                searchRadius = 50000; // 50km
            } else if (zoom <= 10) {
                // Medium zoom (regional) - 2x2 grid
                gridSize = 2;
                searchRadius = 50000;
            } else {
                // Zoomed in (city level) - single search
                gridSize = 1;
                searchRadius = 50000;
            }

            const latStep = (ne.lat() - sw.lat()) / gridSize;
            const lngStep = (ne.lng() - sw.lng()) / gridSize;

            console.log(`Searching ${gridSize}x${gridSize} grid (zoom: ${zoom})`);

            let searchPoints = [];
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const lat = sw.lat() + (i + 0.5) * latStep;
                    const lng = sw.lng() + (j + 0.5) * lngStep;
                    searchPoints.push({ lat, lng });
                }
            }

            let completedSearches = 0;
            let totalResults = 0;

            searchPoints.forEach((point, index) => {
                // Add delay between requests to avoid rate limiting
                setTimeout(() => {
                    const request = {
                        location: new google.maps.LatLng(point.lat, point.lng),
                        radius: searchRadius,
                        type: 'car_dealer'
                    };

                    placesService.nearbySearch(request, (results, status) => {
                        completedSearches++;

                        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                            console.log(`Grid point ${index + 1}: Found ${results.length} dealerships`);
                            totalResults += results.length;

                            results.forEach(place => {
                                // Skip if already processed
                                if (processedPlaceIds.has(place.place_id)) return;
                                processedPlaceIds.add(place.place_id);

                                // Check if it's a client or prospect
                                const isClient = clientNames.some(name =>
                                    place.name.toLowerCase().includes(name.toLowerCase()) ||
                                    name.toLowerCase().includes(place.name.toLowerCase())
                                );

                                const isProspect = prospectNames.some(name =>
                                    place.name.toLowerCase().includes(name.toLowerCase()) ||
                                    name.toLowerCase().includes(place.name.toLowerCase())
                                );

                                // Only show if it's not a client or prospect
                                if (!isClient && !isProspect) {
                                    const dealership = {
                                        name: place.name,
                                        lat: place.geometry.location.lat(),
                                        lng: place.geometry.location.lng(),
                                        place_id: place.place_id,
                                        address: place.vicinity
                                    };
                                    createMarker(dealership, 'other', '#FBBC04');
                                }
                            });
                        } else if (status !== google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                            console.error(`Grid point ${index + 1} error:`, status);
                        }

                        // Check if all searches are complete
                        if (completedSearches === searchPoints.length) {
                            document.getElementById('loading').classList.remove('active');
                            console.log(`Search complete! Found ${totalResults} total dealerships across ${searchPoints.length} search points`);
                            console.log(`Added ${markers.other.length} new dealership markers`);
                            updateDealershipCount();
                        }
                    });
                }, index * 500); // 500ms delay between each search to avoid rate limits
            });
        }

        function showPlaceInfo(marker, dealership) {
            let placeId = dealership.place_id;

            // If no place_id, search for it
            if (!placeId) {
                const request = {
                    query: dealership.name,
                    fields: ['place_id']
                };

                placesService.findPlaceFromQuery(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                        getPlaceDetails(results[0].place_id, marker);
                    } else {
                        showBasicInfo(marker, dealership);
                    }
                });
            } else {
                getPlaceDetails(placeId, marker);
            }
        }

        function getPlaceDetails(placeId, marker) {
            placesService.getDetails({ placeId: placeId }, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    let content = `<div style="max-width: 300px;">`;
                    content += `<h3 style="margin: 0 0 10px 0; color: #333;">${place.name}</h3>`;

                    if (place.formatted_address) {
                        content += `<p style="margin: 5px 0; color: #666;"><strong>üìç Address:</strong><br>${place.formatted_address}</p>`;
                    }

                    if (place.formatted_phone_number) {
                        content += `<p style="margin: 5px 0; color: #666;"><strong>üìû Phone:</strong> <a href="tel:${place.formatted_phone_number}">${place.formatted_phone_number}</a></p>`;
                    }

                    if (place.website) {
                        content += `<p style="margin: 5px 0;"><strong>üåê Website:</strong> <a href="${place.website}" target="_blank">Visit Website</a></p>`;
                    }

                    if (place.rating) {
                        content += `<p style="margin: 5px 0; color: #666;"><strong>‚≠ê Rating:</strong> ${place.rating} / 5 (${place.user_ratings_total || 0} reviews)</p>`;
                    }

                    if (place.opening_hours) {
                        const isOpen = place.opening_hours.isOpen();
                        content += `<p style="margin: 5px 0; color: ${isOpen ? 'green' : 'red'};"><strong>${isOpen ? 'Open Now' : 'Closed'}</strong></p>`;
                    }

                    content += `<p style="margin: 10px 0 0 0;"><a href="https://www.google.com/maps/dir/?api=1&destination=${place.geometry.location.lat()},${place.geometry.location.lng()}" target="_blank" style="color: #4285F4; text-decoration: none; font-weight: bold;">Get Directions ‚Üí</a></p>`;
                    content += `</div>`;

                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                }
            });
        }

        function showBasicInfo(marker, dealership) {
            let content = `<div style="max-width: 300px;">`;
            content += `<h3 style="margin: 0 0 10px 0; color: #333;">${dealership.name}</h3>`;
            if (dealership.address) {
                content += `<p style="margin: 5px 0; color: #666;"><strong>üìç Address:</strong><br>${dealership.address}</p>`;
            }
            content += `<p style="margin: 10px 0 0 0;"><a href="https://www.google.com/maps/search/${encodeURIComponent(dealership.name)}" target="_blank" style="color: #4285F4; text-decoration: none; font-weight: bold;">View on Google Maps ‚Üí</a></p>`;
            content += `</div>`;

            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        function toggleMarkers(type) {
            const visible = document.getElementById(
                type === 'clients' ? 'showClients' :
                type === 'prospects' ? 'showProspects' :
                'showOtherDealerships'
            ).checked;

            markers[type].forEach(marker => {
                marker.setVisible(visible);
            });

            updateDealershipCount();
        }

        function toggleCircles() {
            const visible = document.getElementById('showCircles').checked;
            circles.forEach(circle => {
                circle.setMap(visible ? map : null);
            });
        }

        function clearOtherDealerships() {
            // Clear all yellow "other" dealership markers
            markers.other.forEach(marker => marker.setMap(null));
            markers.other = [];
            processedPlaceIds.clear();
            updateDealershipCount();
            console.log('Cleared all other dealerships');
        }

        function updateDealershipCount() {
            const clientCount = markers.clients.filter(m => m.getVisible()).length;
            const prospectCount = markers.prospects.filter(m => m.getVisible()).length;
            const otherCount = markers.other.filter(m => m.getVisible()).length;

            document.getElementById('dealershipCount').innerHTML =
                `Clients: ${clientCount} | Prospects: ${prospectCount} | Other: ${otherCount}`;
        }

        function toggleSearch() {
            const input = document.getElementById('searchInput');
            searchActive = !searchActive;

            if (searchActive) {
                input.classList.add('active');
                input.focus();
            } else {
                input.classList.remove('active');
                document.getElementById('searchResults').classList.remove('active');
            }
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value;
            const resultsContainer = document.getElementById('searchResults');

            if (query.length === 0) {
                resultsContainer.classList.remove('active');
                return;
            }

            // Use Google Places Autocomplete
            const service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({ input: query }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    resultsContainer.innerHTML = predictions.slice(0, 5).map(p =>
                        `<div class="search-result-item" onclick="goToPlace('${p.place_id}')">
                            <strong>${p.structured_formatting.main_text}</strong><br>
                            <small style="color: #666;">${p.structured_formatting.secondary_text}</small>
                        </div>`
                    ).join('');
                    resultsContainer.classList.add('active');
                } else {
                    resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
                    resultsContainer.classList.add('active');
                }
            });
        }

        function goToPlace(placeId) {
            placesService.getDetails({ placeId: placeId }, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(12);
                    document.getElementById('searchResults').classList.remove('active');
                }
            });
        }

        function toggleControls() {
            document.getElementById('controlPanel').classList.toggle('active');
        }

        function toggleLegend() {
            document.getElementById('legendModal').classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').classList.remove('active');
            }
            if (!e.target.closest('.legend-trigger') && !e.target.closest('.legend-modal')) {
                document.getElementById('legendModal').classList.remove('active');
            }
            if (!e.target.closest('.control-trigger') && !e.target.closest('.control-panel')) {
                document.getElementById('controlPanel').classList.remove('active');
            }
        });
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0sZr4-eSumbogch5S5bGeWQyLap2MMto&libraries=places&callback=initMap">
    </script>
</body>
</html>
